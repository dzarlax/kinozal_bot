# Исправления ошибки "Ошибка поиска на Kinozal. Попробуйте позже."

## Проблема

Пользователи получали ошибку `400 Bad Request` при выполнении поиска на Kinozal, что приводило к сообщению "Ошибка поиска на Kinozal. Попробуйте позже."

**ОБНОВЛЕНИЕ 01.06.2025**: После первого исправления возникла новая проблема - поиск выполнялся успешно, но не находил никаких результатов, даже для популярных запросов.

## Причины ошибки

### Первая проблема (Исправлена ранее)
1. **Неправильная URL-кодировка**: Использовалась простая замена пробелов на `+`, но не выполнялась полная URL-кодировка специальных символов
2. **Отсутствие задержек**: Слишком частые запросы к Kinozal могли вызывать блокировку
3. **Недостаточная обработка ошибок**: При получении 400 ошибки код не предпринимал попыток повторного запроса
4. **Отсутствие контроля частоты запросов**: Пользователи могли отправлять запросы слишком часто

### Вторая проблема (Исправлена 01.06.2025)
5. **Проблема с gzip-декодированием**: Сервер Kinozal отправлял сжатые ответы (gzip), но код не обрабатывал их правильно, что приводило к получению двоичных данных вместо HTML

## Исправления

### 1. Улучшена URL-кодировка (torrent.go)
```go
// Было:
encodedQuery := strings.Replace(query, " ", "+", -1)

// Стало:
encodedQuery := url.QueryEscape(query)
```

### 2. Добавлен механизм повторных попыток (torrent.go)
- Добавлена логика повторных попыток для HTTP запросов (до 3 попыток)
- Прогрессивные задержки между попытками
- Специальная обработка ошибок 400 Bad Request

### 3. Улучшены HTTP заголовки (torrent.go)
Добавлены дополнительные заголовки для лучшей имитации браузера:
```go
req.Header.Set("Accept-Encoding", "gzip, deflate, br")
req.Header.Set("Connection", "keep-alive")
req.Header.Set("Upgrade-Insecure-Requests", "1")
req.Header.Set("Sec-Fetch-Dest", "document")
req.Header.Set("Sec-Fetch-Mode", "navigate")
req.Header.Set("Sec-Fetch-Site", "same-origin")
```

### 4. Добавлена задержка между запросами (torrent.go)
```go
// Задержка 1 секунда перед каждым поиском
time.Sleep(1 * time.Second)
```

### 5. Добавлен контроль частоты запросов пользователей (main.go)
- Пользователи не могут делать поиск чаще чем раз в 10 секунд
- Система отслеживает время последнего запроса каждого пользователя
- Информирует пользователя о времени ожидания

### 6. Улучшены сообщения об ошибках (main.go)
- Добавлено уведомление о процессе поиска
- Более информативные сообщения об ошибках
- Различные сообщения для разных типов ошибок (rate limiting, общие ошибки)

### 7. ИСПРАВЛЕНА ПРОБЛЕМА С GZIP (01.06.2025)
**Ключевое исправление**: Убран заголовок `Accept-Encoding: gzip, deflate, br` для получения несжатых ответов
```go
// Было:
req.Header.Set("Accept-Encoding", "gzip, deflate, br")

// Стало:
// Remove Accept-Encoding header to prevent gzip compression issues
// req.Header.Set("Accept-Encoding", "gzip, deflate, br")
```

**Причина**: Сервер Kinozal отправлял ответы в сжатом формате gzip, но наш код не умел их правильно декодировать, в результате чего получались двоичные данные вместо читаемого HTML.

**Результат**: После удаления этого заголовка сервер стал отправлять несжатые ответы, которые парсер обрабатывает корректно.

## Результат

После внесения всех изменений:
- ✅ Ошибки `400 Bad Request` больше не возникают
- ✅ Поиск работает стабильно и находит все доступные результаты
- ✅ Пользователи получают качественную обратную связь о статусе поиска
- ✅ Снижена нагрузка на сервер Kinozal благодаря контролю частоты запросов
- ✅ Парсинг HTML работает корректно (найдено 50 результатов для запроса "Мстители")

## Диагностические инструменты

В процессе отладки был создан диагностический инструмент, который помог выявить проблему:
- Добавлено расширенное логирование HTML-структуры
- Тестирование различных CSS-селекторов
- Анализ содержимого HTTP-ответов

## Дополнительные рекомендации

1. **Мониторинг логов**: Регулярно проверяйте файл `logs/combined.log` для отслеживания ошибок
2. **Обновление User-Agent**: Периодически обновляйте строку User-Agent для соответствия актуальным браузерам
3. **Резервные механизмы**: При необходимости можно увеличить время задержек или количество повторных попыток
4. **Контроль сжатия**: При изменении серверной конфигурации Kinozal может потребоваться пересмотр обработки сжатых ответов 