# Исправления ошибки "Ошибка поиска на Kinozal. Попробуйте позже."

## Проблема

Пользователи получали ошибку `400 Bad Request` при выполнении поиска на Kinozal, что приводило к сообщению "Ошибка поиска на Kinozal. Попробуйте позже."

## Причины ошибки

1. **Неправильная URL-кодировка**: Использовалась простая замена пробелов на `+`, но не выполнялась полная URL-кодировка специальных символов
2. **Отсутствие задержек**: Слишком частые запросы к Kinozal могли вызывать блокировку
3. **Недостаточная обработка ошибок**: При получении 400 ошибки код не предпринимал попыток повторного запроса
4. **Отсутствие контроля частоты запросов**: Пользователи могли отправлять запросы слишком часто

## Исправления

### 1. Улучшена URL-кодировка (torrent.go)
```go
// Было:
encodedQuery := strings.Replace(query, " ", "+", -1)

// Стало:
encodedQuery := url.QueryEscape(query)
```

### 2. Добавлен механизм повторных попыток (torrent.go)
- Добавлена логика повторных попыток для HTTP запросов (до 3 попыток)
- Прогрессивные задержки между попытками
- Специальная обработка ошибок 400 Bad Request

### 3. Улучшены HTTP заголовки (torrent.go)
Добавлены дополнительные заголовки для лучшей имитации браузера:
```go
req.Header.Set("Accept-Encoding", "gzip, deflate, br")
req.Header.Set("Connection", "keep-alive")
req.Header.Set("Upgrade-Insecure-Requests", "1")
req.Header.Set("Sec-Fetch-Dest", "document")
req.Header.Set("Sec-Fetch-Mode", "navigate")
req.Header.Set("Sec-Fetch-Site", "same-origin")
```

### 4. Добавлена задержка между запросами (torrent.go)
```go
// Задержка 1 секунда перед каждым поиском
time.Sleep(1 * time.Second)
```

### 5. Добавлен контроль частоты запросов пользователей (main.go)
- Пользователи не могут делать поиск чаще чем раз в 10 секунд
- Система отслеживает время последнего запроса каждого пользователя
- Информирует пользователя о времени ожидания

### 6. Улучшены сообщения об ошибках (main.go)
- Добавлено уведомление о процессе поиска
- Более информативные сообщения об ошибках
- Различные сообщения для разных типов ошибок (rate limiting, общие ошибки)

## Результат

После внесения этих изменений:
- Ошибки `400 Bad Request` должны встречаться значительно реже
- Поиск стал более стабильным
- Пользователи получают лучшую обратную связь о статусе поиска
- Снижена нагрузка на сервер Kinozal благодаря контролю частоты запросов

## Дополнительные рекомендации

1. **Мониторинг логов**: Регулярно проверяйте файл `logs/combined.log` для отслеживания ошибок
2. **Обновление User-Agent**: Периодически обновляйте строку User-Agent для соответствия актуальным браузерам
3. **Резервные механизмы**: При необходимости можно увеличить время задержек или количество повторных попыток 